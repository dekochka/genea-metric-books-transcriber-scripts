# Інструмент для транскрипції метричних книг

Цей інструмент автоматично розпізнає та переписує рукописні записи з метричних книг (акти народження, смерті та шлюбів) зі сканованих зображень, використовуючи штучний інтелект Google Gemini. Результати зберігаються у форматованому документі Google Docs з посиланнями на оригінальні зображення.

## Що робить цей інструмент?

### Основна функція

Інструмент автоматично:
1. **Завантажує зображення** з вашої папки Google Drive
2. **Розпізнає рукописний текст** на зображеннях за допомогою штучного інтелекту
3. **Транскрибує записи** у трьох мовах: **російська, українська та латинська**
4. **Створює структурований документ** Google Docs з:
   - Заголовками сторінок з архівними посиланнями
   - Транскрипцією кожної сторінки
   - Посиланнями на оригінальні зображення
   - Метаданими про процес транскрипції

### Приклад: Вхідні дані → Вихідні дані

**Вхідні дані: Папка Google Drive** (Зображення історичних метричних книг):

![Google Drive Folder with Images](data_samples/gdrive_folder_context_before.jpg)

Скрипт обробляє зображення з папки Google Drive, що містить скановані сторінки з історичних метричних книг (акти народження, смерті та шлюбів).

**Вихідні дані: Повний документ транскрипції** - [ДАТО ф487о1с545 1894 Турильче Вербівки народж.pdf](data_samples/ДАТО%20ф487о1с545%201894%20Турильче%20Вербівки%20народж.pdf) - Приклад повного транскрибованого документа, експортованого з Google Docs.

**Вихідні дані: Титульна сторінка Google Doc** (Заголовок документа з зображенням титульної сторінки та транскрипцією):

![Google Doc Title Page](data_samples/gdrive_gdoc_transcribed_title_after.jpg)

Скрипт створює Google Doc з:
- Заголовком документа з датою транскрипції
- Зображенням титульної сторінки (якщо налаштовано) з її транскрипцією
- Підсумком сесії транскрипції з метаданими

**Вихідні дані: Транскрибований запис** (Структурована багатомовна транскрипція):

![Google Doc Transcribed Record](data_samples/gdrive_gdoc_transcribed_record_after.jpg)

Кожен запис транскрибується **російською, українською та латинською мовами**, зберігаючи:
- Імена, дати та родинні зв'язки
- Історичний контекст з оригінального рукописного документа
- Клікабельні посилання на вихідні зображення
- Архівні посилання (якщо налаштовано)

**Приклад вхідного запису** (Метрична книга 19 століття латиною):

![Sample Birth Record](data_samples/latin_turilche_birth_sample_1_record_input.jpg)

**Приклад вихідної транскрипції** (Текстовий формат):

```
Год 1894
Державний Архів Тернопільської Області - Ф. 487, оп. 1, спр. 545
Страница 22

---

### Запись 1: Николай Чепесюк
Турильче (?), дом 24
Николай Чепесюк (род. 18/03/1894)
Родители: Гавриил Чепесюк (сын Максимилиана Чепесюка и Анны Чомулы) и Мария 
  (дочь Ивана Павлюка и Ирины Романюк).
Кумы: Терентий Павлюк и Мария, жена Николая Павлюка.
Заметка: Крестил священник Иосиф Балко. Повитуха Параскева Демкив.

Турильче (?), будинок 24
Микола Чепесюк (нар. 18/03/1894)
Батьки: Гаврило Чепесюк (син Максиміліана Чепесюка та Анни Чомули) та Марія 
  (дочка Івана Павлюка та Ірини Романюк).
Куми: Терентій Павлюк та Марія, дружина Миколи Павлюка.
Замітка: Хрестив священик Йосип Балко. Баба-повитуха Параскева Демків.

Turilcze, domus 24
18 18 Martii 1894 | domus 24 | Nicolaus | Catholicus | Puer | Legitimi |
Parentes: Gabriel filius Maximiliani Czepesiuk et Annae Ciomula; 
  Maria filia Joannis Pawluk et Irenae Romanjuk. agricolae.
Patrini: Terentius Pawluk et Maria uxor Nicolai Pawluk. agricolae.
Notes: Obstetrix non approbata Parasceva Demkiw. 
  Baptisavit confirmavitque Josephus Balko parochus.
```

Модель штучного інтелекту витягує та транскрибує той самий запис **російською, українською та латинською мовами**, зберігаючи імена, дати, родинні зв'язки та історичний контекст з оригінального рукописного документа.

## Вартість використання (витрати на токени)

### Що таке токени?

Токени - це одиниці виміру обсягу тексту, який обробляє штучний інтелект. Один токен приблизно дорівнює 0.75 слова українською мовою.

### Вартість обробки

Інструмент використовує модель **Gemini 3 Flash Preview** від Google. Вартість обробки:

- **Вхідні токени** (зображення + інструкції): **$0.15 за 1 мільйон токенів**
- **Вихідні токени** (транскрипція): **$0.60 за 1 мільйон токенів**
- **Кешовані токени** (повторне використання): **$0.03 за 1 мільйон токенів**

### Приклад розрахунку вартості

Для **однієї сторінки метричної книги**:
- Вхідні токени: ~6,000-8,000 токенів (зображення + інструкції)
- Вихідні токени: ~2,500-3,500 токенів (транскрипція)
- **Приблизна вартість однієї сторінки: $0.002-0.003** (менше 1 копійки)

Для **100 сторінок**:
- **Приблизна вартість: $0.20-0.30** (20-30 копійок)

### Важливо про витрати

1. **Перші $300 безкоштовно**: Google надає безкоштовний кредит $300 для нових користувачів Google Cloud
2. **Вартість відображається в логах**: Після кожної сесії транскрипції ви побачите точну вартість в документі Google Docs
3. **Можна контролювати**: Ви можете обмежити кількість оброблених зображень через налаштування

## Передумови та встановлення

### Що потрібно перед початком роботи

1. **Комп'ютер** з операційною системою Windows, macOS або Linux
2. **Інтернет-з'єднання**
3. **Обліковий запис Google** (Gmail)
4. **Python 3.10 або новіший** (безкоштовна програма для запуску скриптів)

### Крок 1: Встановлення Python

#### Windows:
1. Перейдіть на https://www.python.org/downloads/
2. Завантажте останню версію Python 3.10 або новішу
3. Під час встановлення **обов'язково** поставте галочку "Add Python to PATH"
4. Натисніть "Install Now"

#### macOS:
1. Відкрийте Terminal (Програми → Утиліти → Terminal)
2. Введіть: `brew install python3` (якщо встановлено Homebrew)
3. Або завантажте з https://www.python.org/downloads/macos/

#### Перевірка встановлення:
Відкрийте командний рядок (Terminal на macOS/Linux, Command Prompt на Windows) і введіть:
```bash
python3 --version
```
Повинно з'явитися щось на кшталт: `Python 3.10.0` або новіше.

### Крок 2: Створення проекту Google Cloud

1. **Перейдіть на https://console.cloud.google.com/**
2. **Увійдіть** у свій обліковий запис Google
3. **Створіть новий проект**:
   - Натисніть на випадаюче меню проекту (зверху)
   - Натисніть "New Project"
   - Введіть назву проекту (наприклад: "ukr-transcribe-genea")
   - Натисніть "Create"
4. **Увімкніть необхідні API**:
   - Перейдіть до "APIs & Services" → "Library"
   - Знайдіть та увімкніть:
     - **Vertex AI API**
     - **Google Drive API**
     - **Google Docs API**
   - Для кожного API натисніть "Enable"

### Крок 3: Налаштування аутентифікації (gcloud ADC - рекомендований метод)

Цей метод простіший і безпечніший, ніж OAuth.

1. **Встановіть Google Cloud SDK**:
   - Windows: https://cloud.google.com/sdk/docs/install
   - macOS: `brew install google-cloud-sdk`
   - Linux: https://cloud.google.com/sdk/docs/install

2. **Відкрийте Terminal/Command Prompt** і виконайте:
   ```bash
   gcloud auth application-default login --project=ВАШ_ПРОЕКТ_ID --scopes=https://www.googleapis.com/auth/drive,https://www.googleapis.com/auth/documents,https://www.googleapis.com/auth/cloud-platform
   ```
   Замініть `ВАШ_ПРОЕКТ_ID` на ID вашого проекту (наприклад: `ukr-transcribe-genea`)

3. **Відкриється браузер** - увійдіть у свій Google акаунт і надайте дозволи

4. **Файл `application_default_credentials.json`** буде створено автоматично в папці користувача

### Крок 4: Підготовка папки Google Drive

1. **Створіть папку** в Google Drive для зображень метричних книг
2. **Завантажте зображення** сторінок метричних книг у цю папку
3. **Отримайте ID папки**:
   - Відкрийте папку в Google Drive
   - Скопіюйте ID з URL (частина після `folders/`)
   - Наприклад, якщо URL: `https://drive.google.com/drive/folders/1YHAeW5Yi8oeKqvQHHKHf8u0o_MpTKJPR`
   - То ID папки: `1YHAeW5Yi8oeKqvQHHKHf8u0o_MpTKJPR`
4. **Надайте доступ**:
   - Натисніть правою кнопкою на папку → "Share" (Поділитися)
   - Додайте свій Google акаунт як "Editor" (Редактор)

### Крок 5: Завантаження та встановлення інструменту

1. **Завантажте код**:
   ```bash
   git clone https://github.com/dekochka/genea-metric-books-transcriber-scripts.git
   cd genea-metric-books-transcriber-scripts
   ```
   Або завантажте ZIP-архів з GitHub і розпакуйте

2. **Створіть віртуальне середовище Python**:
   ```bash
   python3 -m venv venv
   ```

3. **Активуйте віртуальне середовище**:
   - Windows:
     ```bash
     venv\Scripts\activate
     ```
   - macOS/Linux:
     ```bash
     source venv/bin/activate
     ```

4. **Встановіть необхідні бібліотеки**:
   ```bash
   pip install -r requirements.txt
   ```

### Крок 6: Налаштування конфігурації

1. **Скопіюйте файл конфігурації**:
   ```bash
   cp config/config.yaml.example config/my-project.yaml
   ```

2. **Відкрийте файл `config/my-project.yaml`** у текстовому редакторі

3. **Налаштуйте параметри**:

   ```yaml
   # Файл інструкцій для транскрипції
   prompt_file: "f487o1s545-Turilche.md"  # Назва файлу з папки prompts/
   
   # ID вашого Google Cloud проекту
   project_id: "ukr-transcribe-genea"  # Замініть на ваш проект
   
   # ID папки Google Drive з зображеннями
   drive_folder_id: "1YHAeW5Yi8oeKqvQHHKHf8u0o_MpTKJPR"  # Замініть на ваш ID
   
   # Архівний індекс (опціонально)
   archive_index: "ф487оп1спр545"  # Формат: ф[ФОНД]оп[ОПИС]спр[СПРАВА]
   
   # Модель штучного інтелекту
   ocr_model_id: "gemini-3-flash-preview"
   
   # З якого зображення почати (номер у назві файлу)
   image_start_number: 1
   
   # Скільки зображень обробити
   image_count: 100
   
   # Скільки зображень обробити перед створенням документа
   batch_size_for_doc: 2
   ```

4. **Створіть файл інструкцій** (якщо потрібно):
   - Скопіюйте один з прикладів з папки `prompts/`
   - Відредагуйте секцію "Context" з назвами сіл та прізвищами для вашої метричної книги
   - Збережіть у папці `prompts/`
   - Вкажіть назву файлу в `prompt_file`

5. **Перемістіть файл `application_default_credentials.json`**:
   - Якщо ви використовували gcloud ADC, файл вже в правильному місці
   - Якщо файл в іншому місці, скопіюйте його в кореневу папку проекту

## Запуск та моніторинг

### Запуск транскрипції

1. **Активуйте віртуальне середовище** (якщо ще не активовано):
   - Windows: `venv\Scripts\activate`
   - macOS/Linux: `source venv/bin/activate`

2. **Запустіть скрипт**:
   ```bash
   python3 transcribe.py config/my-project.yaml
   ```

3. **Скрипт почне роботу**:
   - Завантажить список зображень з Google Drive
   - Почне обробку зображень по черзі
   - Створить Google Doc після першої партії зображень
   - Продовжить додавати транскрипції до документа

### Моніторинг процесу

#### Що відбувається під час роботи:

1. **Завантаження зображень**: Скрипт завантажує кожне зображення з Google Drive
2. **Обробка AI**: Кожне зображення відправляється до Google Gemini для розпізнавання
3. **Транскрипція**: AI повертає транскрипцію у трьох мовах
4. **Запис у документ**: Транскрипції додаються до Google Doc

#### Де дивитися прогрес:

1. **У терміналі** (командному рядку):
   - Ви побачите повідомлення про прогрес
   - Наприклад: `[20:51:48] Processing image 1/100: 'image00001.jpg'`
   - `[20:52:14] ✓ Successfully completed image 1/100`

2. **У файлах логів**:
   - `logs/YYYYMMDD_HHMMSS-transcribe-session-XXXXX.log` - загальний прогрес
   - `logs/YYYYMMDD_HHMMSS-ai-responses.log` - повні відповіді AI

3. **У Google Doc**:
   - Після обробки першої партії з'явиться документ у папці Google Drive
   - Документ оновлюється після кожної партії зображень

#### Типові повідомлення:

- ✅ `✓ Successfully completed image X/Y` - зображення успішно оброблено
- ⏳ `Attempt 1/3 for image...` - повторна спроба обробки
- ⚠️ `Warning: ...` - попередження (не критично)
- ❌ `Error: ...` - помилка (перевірте логи)

### Час обробки

- **Одна сторінка**: 20-30 секунд (залежить від складності)
- **100 сторінок**: приблизно 30-50 хвилин
- **Перше зображення може зайняти більше часу** (холодний старт AI)

### Результати роботи

Після завершення роботи ви отримаєте:

1. **Google Doc** з транскрипціями:
   - Заголовок документа з датою
   - Зображення титульної сторінки (якщо налаштовано)
   - Транскрипції всіх сторінок з заголовками
   - Посилання на оригінальні зображення
   - Підсумок сесії з метаданими та вартістю

2. **Файли логів** у папці `logs/`:
   - Детальний лог процесу
   - Повні відповіді AI для кожного зображення

3. **Інформація про витрати**:
   - У документі Google Doc в розділі "TRANSCRIPTION RUN SUMMARY"
   - Показує точну вартість обробки

## Вирішення проблем

### Помилка: "FileNotFoundError: Configuration file not found"

**Причина**: Неправильний шлях до файлу конфігурації

**Рішення**: Перевірте, що файл конфігурації знаходиться в папці `config/` і ви правильно вказали шлях:
```bash
python3 transcribe.py config/my-project.yaml
```

### Помилка: "403 access_denied" або "app not verified"

**Причина**: Проблеми з аутентифікацією

**Рішення**: 
1. Переконайтеся, що ви виконали `gcloud auth application-default login`
2. Перевірте, що файл `application_default_credentials.json` знаходиться в кореневій папці проекту
3. Переконайтеся, що ваш проект Google Cloud має увімкнені всі необхідні API

### Помилка: "No images found"

**Причина**: Неправильний ID папки або проблеми з доступом

**Рішення**:
1. Перевірте `drive_folder_id` у файлі конфігурації
2. Переконайтеся, що папка Google Drive надана вашому акаунту як "Editor"
3. Перевірте, що назви файлів відповідають підтримуваним форматам

### Помилка: "TimeoutError" або обробка зависає

**Причина**: Зображення занадто складне або проблеми з інтернетом

**Рішення**:
1. Скрипт автоматично повторює спробу (до 3 разів)
2. Якщо помилка повторюється, перевірте інтернет-з'єднання
3. Можна обробити проблемне зображення окремо пізніше

### Як продовжити після переривання

Якщо скрипт перервався:

1. **Перевірте логи** - знайдіть останнє успішно оброблене зображення
2. **Оновіть конфігурацію**:
   - Встановіть `image_start_number` на номер наступного зображення
   - Наприклад, якщо оброблено 50 зображень, встановіть `image_start_number: 51`
3. **Запустіть скрипт знову** - він продовжить з того місця, де зупинився
4. **Вже створений Google Doc** буде оновлено новими транскрипціями

### Відновлення документа з логів

Якщо скрипт завершився з помилкою після транскрипції:

1. **Знайдіть файл логу** у папці `logs/` (назва містить дату та час)
2. **Запустіть скрипт відновлення**:
   ```bash
   python3 recovery_script.py logs/YYYYMMDD_HHMMSS-ai-responses.log --doc-title "transcription_recovered"
   ```
3. **Скрипт створить новий Google Doc** з усіма транскрипціями з логу

## Поради для кращих результатів

1. **Якість зображень**: Чим краща якість сканування, тим точніша транскрипція
2. **Підготовка інструкцій**: Детальні інструкції з назвами сіл та прізвищами покращують точність
3. **Обробка партіями**: Обробляйте по 50-100 сторінок за раз для кращого контролю
4. **Перевірка результатів**: Завжди перевіряйте транскрипції, особливо імена та дати
5. **Резервне копіювання**: Експортуйте Google Doc у PDF для збереження

## Додаткова інформація

### Підтримувані формати назв файлів

- `image (N).jpg` (наприклад: `image (7).jpg`)
- `imageNNNNN.jpg` (наприклад: `image00101.jpg`)
- `NNNNN.jpg` (наприклад: `216.jpg`)
- `image - YYYY-MM-DDTHHMMSS.mmm.jpg` (формат з датою)
- `PREFIX_NNNNN.jpg` (наприклад: `004933159_00216.jpeg`)

### Структура вихідного документа

Google Doc містить:
1. **Заголовок документа** з назвою та датою транскрипції
2. **Зображення титульної сторінки** (якщо налаштовано) з транскрипцією
3. **Підсумок сесії** з метаданими:
   - Назва документа
   - Посилання на папку
   - Архівний індекс
   - Час початку та завершення
   - Модель AI
   - Файл інструкцій
   - Кількість оброблених файлів
   - Помилки (якщо є)
   - Метрики (час, токени, вартість)
4. **Транскрипції сторінок**:
   - Заголовок сторінки з архівним посиланням
   - Посилання на оригінальне зображення
   - Транскрипція у трьох мовах

### Контакти та підтримка

Якщо у вас виникли питання або проблеми:
- Перевірте файл `README.md` для технічної документації
- Перевірте логи для детальної інформації про помилки
- Створіть issue на GitHub репозиторії

---

**Важливо**: Штучний інтелект може робити помилки в транскрипції імен та прізвищ. Завжди перевіряйте результати з оригінальними документами. Використовуйте транскрипції як приблизний переклад та верифікуйте з джерелом.
